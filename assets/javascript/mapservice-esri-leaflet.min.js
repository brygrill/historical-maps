/*! Esri-Leaflet - v0.0.1 - 2013-09-17
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(e,t){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=t()),"object"==typeof window&&(e.Terraformer=t())}(this,function(){function e(){var e=Array.prototype.slice.apply(arguments)
void 0!==typeof console&&console.warn&&console.warn.apply(console,e)}function t(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])
return e}function r(e){switch(e.type){case"Point":return[e.coordinates[0],e.coordinates[1],e.coordinates[0],e.coordinates[1]]
case"MultiPoint":return n(e.coordinates)
case"LineString":return n(e.coordinates)
case"MultiLineString":return i(e.coordinates)
case"Polygon":return i(e.coordinates)
case"MultiPolygon":return o(e.coordinates)
case"Feature":return r(e.geometry)
case"FeatureCollection":return s(e)
case"GeometryCollection":return a(e)
default:throw new Error("Unknown type: "+e.type)}}function i(e){for(var t=null,r=null,i=null,o=null,n=0;n<e.length;n++)for(var s=e[n],a=0;a<s.length;a++){var l=s[a],h=l[0],c=l[1]
null===t?t=h:t>h&&(t=h),null===r?r=h:h>r&&(r=h),null===i?i=c:i>c&&(i=c),null===o?o=c:c>o&&(o=c)}return[t,i,r,o]}function o(e){for(var t=null,r=null,i=null,o=null,n=0;n<e.length;n++)for(var s=e[n],a=0;a<s.length;a++)for(var l=s[a],h=0;h<l.length;h++){var c=l[h],u=c[0],p=c[1]
null===t?t=u:t>u&&(t=u),null===r?r=u:u>r&&(r=u),null===i?i=p:i>p&&(i=p),null===o?o=p:p>o&&(o=p)}return[t,i,r,o]}function n(e){for(var t=null,r=null,i=null,o=null,n=0;n<e.length;n++){var s=e[n],a=s[0],l=s[1]
null===t?t=a:t>a&&(t=a),null===r?r=a:a>r&&(r=a),null===i?i=l:i>l&&(i=l),null===o?o=l:l>o&&(o=l)}return[t,i,r,o]}function s(e){for(var t,i=[],o=e.features.length-1;o>=0;o--)t=r(e.features[o].geometry),i.push([t[0],t[1]]),i.push([t[2],t[3]])
return n(i)}function a(e){for(var t,i=[],o=e.geometries.length-1;o>=0;o--)t=r(e.geometries[o]),i.push([t[0],t[1]]),i.push([t[2],t[3]])
return n(i)}function l(e){var t=r(e)
return{x:t[0],y:t[1],w:Math.abs(t[0]-t[2]),h:Math.abs(t[1]-t[3])}}function h(e){return e*Q}function c(e){return e*$}function u(e,t){for(var r=0;r<e.length;r++)"number"==typeof e[r][0]&&(e[r]=t(e[r])),"object"==typeof e[r]&&(e[r]=u(e[r],t))
return e}function p(e){var t=e[0],r=e[1]
return[h(t/X)-360*Math.floor((h(t/X)+180)/360),h(Math.PI/2-2*Math.atan(Math.exp(-1*r/X)))]}function f(e){var t=e[0],r=Math.max(Math.min(e[1],89.99999),-89.99999)
return[c(t)*X,X/2*Math.log((1+Math.sin(c(r)))/(1-Math.sin(c(r))))]}function d(e,t,r){if("Point"===e.type)e.coordinates=t(e.coordinates)
else if("Feature"===e.type)e.geometry=d(e.geometry,t,!0)
else if("FeatureCollection"===e.type)for(var i=0;i<e.features.length;i++)e.features[i]=d(e.features[i],t,!0)
else if("GeometryCollection"===e.type)for(var o=0;o<e.geometries.length;o++)e.geometries[o]=d(e.geometries[o],t,!0)
else e.coordinates=u(e.coordinates,t)
return r||t===f&&(e.crs=K),t===p&&delete e.crs,e}function y(e){return d(e,f)}function g(e){return d(e,p)}function m(e,t){return t>e?-1:e>t?1:0}function v(e,t){return e[0]-t[0]>e[1]-t[1]?1:e[0]-t[0]<e[1]-t[1]?-1:0}function _(e,t,r){return m((t[0]-e[0])*(r[1]-e[1])-(r[0]-e[0])*(t[1]-e[1]),0)}function x(e,t){var r=t[0]-e[0],i=t[1]-e[1]
return r*r+i*i}function w(e,t){var r=t
for(var i in e){var o=_(t,r,e[i]);(-1===o||0===o&&x(t,e[i])>x(t,r))&&(r=e[i])}return r}function b(e){if(0===e.length)return[]
if(1===e.length)return e
for(var t=[e.sort(v)[0]],r=0;r<t.length;r++){var i=w(e,t[r])
i!==t[0]&&t.push(i)}return t}function L(e,t){for(var r=!1,i=-1,o=e.length,n=o-1;++i<o;n=i)(e[i][1]<=t[1]&&t[1]<e[n][1]||e[n][1]<=t[1]&&t[1]<e[i][1])&&t[0]<(e[n][0]-e[i][0])*(t[1]-e[i][1])/(e[n][1]-e[i][1])+e[i][0]&&(r=!r)
return r}function M(e,t){if(e&&e.length){if(1===e.length)return L(e[0],t)
if(L(e[0],t)){for(var r=1;r<e.length;r++)if(L(e[r],t))return!1
return!0}return!1}return!1}function S(e,t,r,i){var o=(i[0]-r[0])*(e[1]-r[1])-(i[1]-r[1])*(e[0]-r[0]),n=(t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]),s=(i[1]-r[1])*(t[0]-e[0])-(i[0]-r[0])*(t[1]-e[1])
if(0!==s){var a=o/s,l=n/s
if(a>=0&&1>=a&&l>=0&&1>=l)return!0}return!1}function P(e,t){for(var r=0;r<e.length-1;r++)for(var i=0;i<t.length-1;i++)if(S(e[r],e[r+1],t[i],t[i+1]))return!0
return!1}function T(e,t){for(var r=0;r<t.length;r++)for(var i=t[r],o=0;o<i.length-1;o++)for(var n=0;n<e.length-1;n++)if(S(i[o],i[o+1],e[n],e[n+1]))return!0
return!1}function R(e,t){for(var r=0;r<e.length;r++)if(T(e[r],t))return!0
return!1}function A(e,t){for(var r=0;r<t.length;r++)return T(e,t[r])?!0:!1}function U(e,t){for(var r=0;r<e.length;r++)return A(e[r],t)?!0:!1}function z(e,t){for(var r=0;r<e.length;r++)return U(e[r],t)?!0:!1}function I(e){for(var t=[],r=0;r<e.length;r++){var i=e[r].slice()
G(i[0],i[i.length-1])===!1&&i.push(i[0]),t.push(i)}return t}function G(e,t){for(var r=0;r<e.length;r++)for(var i=0;i<t.length;i++)if(e[r]!==t[i])return!1
return!0}function O(e,t){if(e.length!==t.length)return!1
for(var r=e.slice().sort(v),i=t.slice().sort(v),o=0;o<r.length;o++){if(r[o].length!==i[o].length)return!1
for(var n=0;n<r.length;n++)if(r[o][n]!==i[o][n])return!1}return!0}function C(e){if(e)switch(e.type){case"Point":return new B(e)
case"MultiPoint":return new E(e)
case"LineString":return new k(e)
case"MultiLineString":return new F(e)
case"Polygon":return new Z(e)
case"MultiPolygon":return new N(e)
case"Feature":return new q(e)
case"FeatureCollection":return new D(e)
case"GeometryCollection":return new W(e)
default:throw new Error("Unknown type: "+e.type)}}function B(e){var r=Array.prototype.slice.call(arguments)
if(e&&"Point"===e.type&&e.coordinates)t(this,e)
else if(e&&"[object Array]"===Object.prototype.toString.call(e))this.coordinates=e
else{if(!(r.length>=2))throw"Terraformer: invalid input for Terraformer.Point"
this.coordinates=r}this.type="Point"}function E(e){if(e&&"MultiPoint"===e.type&&e.coordinates)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPoint"
this.coordinates=e}this.type="MultiPoint"}function k(e){if(e&&"LineString"===e.type&&e.coordinates)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.LineString"
this.coordinates=e}this.type="LineString"}function F(e){if(e&&"MultiLineString"===e.type&&e.coordinates)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiLineString"
this.coordinates=e}this.type="MultiLineString"}function Z(e){if(e&&"Polygon"===e.type&&e.coordinates)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.Polygon"
this.coordinates=e}this.type="Polygon"}function N(e){if(e&&"MultiPolygon"===e.type&&e.coordinates)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPolygon"
this.coordinates=e}this.type="MultiPolygon"}function q(e){if(e&&"Feature"===e.type&&e.geometry)t(this,e)
else{if(!(e&&e.type&&e.coordinates))throw"Terraformer: invalid input for Terraformer.Feature"
this.geometry=e}this.type="Feature"}function D(e){if(e&&"FeatureCollection"===e.type&&e.features)t(this,e)
else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.FeatureCollection"
this.features=e}this.type="FeatureCollection"}function W(e){if(e&&"GeometryCollection"===e.type&&e.geometries)t(this,e)
else if(Array.isArray(e))this.geometries=e
else{if(!e.coordinates||!e.type)throw"Terraformer: invalid input for Terraformer.GeometryCollection"
this.type="GeometryCollection",this.geometries=[e]}this.type="GeometryCollection"}function J(e,t,r){for(var i=f(e),o=r||64,n={type:"Polygon",coordinates:[[]]},s=1;o>=s;s++){var a=s*(360/o)*Math.PI/180
n.coordinates[0].push([i[0]+t*Math.cos(a),i[1]+t*Math.sin(a)])}return g(n)}function H(e,r,i){var o=i||64,n=r||250
if(!e||e.length<2||!n||!o)throw new Error("Terraformer: missing parameter for Terraformer.Circle")
t(this,new q({type:"Feature",geometry:J(e,n,o),properties:{radius:n,center:e,steps:o}}))}var V={},X=6378137,Q=57.29577951308232,$=.017453292519943,K={type:"link",properties:{href:"http://spatialreference.org/ref/sr-org/6928/ogcwkt/",type:"ogcwkt"}},Y={type:"link",properties:{href:"http://spatialreference.org/ref/epsg/4326/ogcwkt/",type:"ogcwkt"}},ee=["length"]
return C.prototype.toMercator=function(){return y(this)},C.prototype.toGeographic=function(){return g(this)},C.prototype.envelope=function(){return l(this)},C.prototype.bbox=function(){return r(this)},C.prototype.convexHull=function(){var e,t,r=[]
if("Point"===this.type)return this.coordinates&&this.coordinates.length>0?[this.coordinates]:[]
if("LineString"===this.type||"MultiPoint"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[]
r=this.coordinates}else if("Polygon"===this.type||"MultiLineString"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[]
for(e=0;e<this.coordinates.length;e++)r=r.concat(this.coordinates[e])}else{if("MultiPolygon"!==this.type)throw new Error("Unable to get convex hull of "+this.type)
if(!(this.coordinates&&this.coordinates.length>0))return[]
for(e=0;e<this.coordinates.length;e++)for(t=0;t<this.coordinates[e].length;t++)r=r.concat(this.coordinates[e][t])}return b(r)},C.prototype.toJSON=function(){var e={}
for(var t in this)this.hasOwnProperty(t)&&-1===ee.indexOf(t)&&(e[t]=this[t])
return e.bbox=r(this),e},C.prototype.within=function(e){var t,r,i
if("Point"===e.type&&"Point"===this.type)return G(this.coordinates,e.coordinates)
if("MultiLineString"===e.type&&"Point"===this.type)for(r=0;r<e.coordinates.length;r++){var o={type:"LineString",coordinates:e.coordinates[r]}
if(this.within(o))return!0}if(("LineString"===e.type||"MultiPoint"===e.type)&&"Point"===this.type)for(r=0;r<e.coordinates.length;r++){if(this.coordinates.length!==e.coordinates[r].length)return!1
if(G(this.coordinates,e.coordinates[r]))return!0}if("Polygon"===e.type){if("Polygon"===this.type){if(e.coordinates.length===this.coordinates.length)for(r=0;r<this.coordinates.length;r++)if(O(this.coordinates[r],e.coordinates[r]))return!0
return this.coordinates.length&&M(e.coordinates,this.coordinates[0][0])?!R(I(this.coordinates),I(e.coordinates)):!1}if("Point"===this.type)return M(e.coordinates,this.coordinates)
if("LineString"===this.type||"MultiPoint"===this.type){if(!this.coordinates||0===this.coordinates.length)return!1
for(r=0;r<this.coordinates.length;r++)if(M(e.coordinates,this.coordinates[r])===!1)return!1
return!0}if("MultiLineString"===this.type){for(r=0;r<this.coordinates.length;r++){var n=new k(this.coordinates[r])
if(n.within(e)===!1)return i++,!1}return!0}if("MultiPolygon"===this.type){for(r=0;r<this.coordinates.length;r++){var s=new C({type:"Polygon",coordinates:this.coordinates[r]})
if(s.within(e)===!1)return!1}return!0}}if("MultiPolygon"===e.type){if("Point"===this.type){if(e.coordinates.length)for(r=0;r<e.coordinates.length;r++)if(t=e.coordinates[r],M(t,this.coordinates)&&R(this.coordinates,e.coordinates)===!1)return!0
return!1}if("Polygon"===this.type){for(r=0;r<this.coordinates.length;r++)if(e.coordinates[r].length===this.coordinates.length)for(j=0;j<this.coordinates.length;j++)if(O(this.coordinates[j],e.coordinates[r][j]))return!0
if(U(this.coordinates,e.coordinates)===!1&&e.coordinates.length){for(r=0;r<e.coordinates.length;r++)t=e.coordinates[r],i=M(t,this.coordinates[0][0])===!1?!1:!0
return i}}else if("LineString"===this.type||"MultiPoint"===this.type)for(r=0;r<e.coordinates.length;r++){var a={type:"Polygon",coordinates:e.coordinates[r]}
return this.within(a)?!0:!1}else{if("MultiLineString"===this.type){for(r=0;r<this.coordinates.length;r++){var l=new k(this.coordinates[r])
if(l.within(e)===!1)return!1}return!0}if("MultiPolygon"===this.type){for(r=0;r<e.coordinates.length;r++){var h={type:"Polygon",coordinates:e.coordinates[r]}
if(this.within(h)===!1)return!1}return!0}}}return!1},C.prototype.intersects=function(t){"Feature"===t.type&&(t=t.geometry)
var r=new C(t)
if(this.within(t)||r.within(this))return!0
if("LineString"===this.type){if("LineString"===t.type)return P(this.coordinates,t.coordinates)
if("MultiLineString"===t.type)return T(this.coordinates,t.coordinates)
if("Polygon"===t.type)return T(this.coordinates,I(t.coordinates))
if("MultiPolygon"===t.type)return A(this.coordinates,t.coordinates)}else if("MultiLineString"===this.type){if("LineString"===t.type)return T(t.coordinates,this.coordinates)
if("Polygon"===t.type||"MultiLineString"===t.type)return R(this.coordinates,t.coordinates)
if("MultiPolygon"===t.type)return U(this.coordinates,t.coordinates)}else if("Polygon"===this.type){if("LineString"===t.type)return T(t.coordinates,I(this.coordinates))
if("MultiLineString"===t.type)return R(I(this.coordinates),t.coordinates)
if("Polygon"===t.type)return R(I(this.coordinates),I(t.coordinates))
if("MultiPolygon"===t.type)return U(I(this.coordinates),t.coordinates)}else if("MultiPolygon"===this.type){if("LineString"===t.type)return A(t.coordinates,this.coordinates)
if("Polygon"===t.type||"MultiLineString"===t.type)return U(I(t.coordinates),this.coordinates)
if("MultiPolygon"===t.type)return z(this.coordinates,t.coordinates)}else if("Feature"===this.type){var i=new C(this.geometry)
return i.intersects(t)}return e("Type "+this.type+" to "+t.type+" intersection is not supported by intersects"),!1},B.prototype=new C,B.prototype.constructor=B,E.prototype=new C,E.prototype.constructor=E,E.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])
return this},E.prototype.addPoint=function(e){return this.coordinates.push(e),this},E.prototype.insertPoint=function(e,t){return this.coordinates.splice(t,0,e),this},E.prototype.removePoint=function(e){return"number"==typeof e?this.coordinates.splice(e,1):this.coordinates.splice(this.coordinates.indexOf(e),1),this},E.prototype.get=function(e){return new B(this.coordinates[e])},k.prototype=new C,k.prototype.constructor=k,k.prototype.addVertex=function(e){return this.coordinates.push(e),this},k.prototype.insertVertex=function(e,t){return this.coordinates.splice(t,0,e),this},k.prototype.removeVertex=function(e){return this.coordinates.splice(e,1),this},F.prototype=new C,F.prototype.constructor=F,F.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},F.prototype.get=function(e){return new k(this.coordinates[e])},Z.prototype=new C,Z.prototype.constructor=Z,Z.prototype.addVertex=function(e){return this.coordinates[0].push(e),this},Z.prototype.insertVertex=function(e,t){return this.coordinates[0].splice(t,0,e),this},Z.prototype.removeVertex=function(e){return this.coordinates[0].splice(e,1),this},Z.prototype.close=function(){this.coordinates=I(this.coordinates)},N.prototype=new C,N.prototype.constructor=N,N.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},N.prototype.get=function(e){return new Z(this.coordinates[e])},q.prototype=new C,q.prototype.constructor=q,D.prototype=new C,D.prototype.constructor=D,D.prototype.forEach=function(e){for(var t=0;t<this.features.length;t++)e.apply(this,[this.features[t],t,this.features])},D.prototype.get=function(e){var t
return this.forEach(function(r){r.id===e&&(t=r)}),new q(t)},W.prototype=new C,W.prototype.constructor=W,W.prototype.forEach=function(e){for(var t=0;t<this.geometries.length;t++)e.apply(this,[this.geometries[t],t,this.geometries])},W.prototype.get=function(e){return new C(this.geometries[e])},H.prototype=new C,H.prototype.constructor=H,H.prototype.recalculate=function(){return this.geometry=J(this.properties.center,this.properties.radius,this.properties.steps),this},H.prototype.center=function(e){return e&&(this.properties.center=e,this.recalculate()),this.properties.center},H.prototype.radius=function(e){return e&&(this.properties.radius=e,this.recalculate()),this.properties.radius},H.prototype.steps=function(e){return e&&(this.properties.steps=e,this.recalculate()),this.properties.steps},H.prototype.toJSON=function(){var e=C.prototype.toJSON.call(this)
return e},V.Primitive=C,V.Point=B,V.MultiPoint=E,V.LineString=k,V.MultiLineString=F,V.Polygon=Z,V.MultiPolygon=N,V.Feature=q,V.FeatureCollection=D,V.GeometryCollection=W,V.Circle=H,V.toMercator=y,V.toGeographic=g,V.Tools={},V.Tools.positionToMercator=f,V.Tools.positionToGeographic=p,V.Tools.applyConverter=d,V.Tools.toMercator=y,V.Tools.toGeographic=g,V.Tools.createCircle=J,V.Tools.calculateBounds=r,V.Tools.calculateEnvelope=l,V.Tools.coordinatesContainPoint=L,V.Tools.polygonContainsPoint=M,V.Tools.arrayIntersectsArray=P,V.Tools.coordinatesContainPoint=L,V.Tools.coordinatesEqual=O,V.Tools.convexHull=b,V.MercatorCRS=K,V.GeographicCRS=Y,V}),function(e,t){if("object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=t(require("terraformer"))),"object"==typeof e.navigator){if(!e.Terraformer)throw new Error("Terraformer.ArcGIS requires the core Terraformer library. https://github.com/esri/Terraformer")
e.Terraformer.ArcGIS=t(e.Terraformer)}}(this,function(e){function t(e){var t={}
for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])
return t}function r(e){var t,r=0,i=0,o=e.length,n=e[i]
for(i;o-1>i;i++)t=e[i+1],r+=(t[0]-n[0])*(t[1]+n[1]),n=t
return r>=0}function i(e){var t=[],i=e.slice(0),o=i.shift().slice(0)
r(o)||o.reverse(),t.push(o)
for(var n=0;n<i.length;n++){var s=i[n].slice(0)
r(s)&&s.reverse(),t.push(s)}return t}function o(e){for(var t=[],r=0;r<e.length;r++)for(var o=i(e[r]),n=o.length-1;n>=0;n--){var s=o[n].slice(0)
t.push(s)}return t}function n(t,r){var i=e.Tools.arrayIntersectsArray(t,r),o=e.Tools.coordinatesContainPoint(t,r[0])
return!i&&o?!0:!1}function s(e){for(var t=[],i=[],o=0;o<e.length;o++){var s=e[o].slice(0)
if(r(s)){var a=[s]
t.push(a)}else i.push(s)}for(;i.length;){for(var l=i.pop(),h=!1,c=t.length-1;c>=0;c--){var u=t[c][0]
if(n(u,l)){t[c].push(l),h=!0
break}}h||t.push([l.reverse()])}return 1===t.length?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}function a(r){var i={}
r.x&&r.y&&(i.type="Point",i.coordinates=[r.x,r.y]),r.points&&(i.type="MultiPoint",i.coordinates=r.points.slice(0)),r.paths&&(1===r.paths.length?(i.type="LineString",i.coordinates=r.paths[0].slice(0)):(i.type="MultiLineString",i.coordinates=r.paths.slice(0))),r.rings&&(i=s(r.rings.slice(0))),r.geometry&&(i.type="Feature",i.geometry=a(r.geometry),i.properties=t(r.attributes)||{})
var o=r.geometry?r.geometry.spatialReference:r.spatialReference
return o&&102100===o.wkid&&(i=e.toGeographic(i)),new e.Primitive(i)}function l(r,n){var s
s=n?n:r&&r.crs===e.MercatorCRS?{wkid:102100}:{wkid:4326}
var a,h={}
switch(r.type){case"Point":h.x=r.coordinates[0],h.y=r.coordinates[1],h.spatialReference=s
break
case"MultiPoint":h.points=r.coordinates.slice(0),h.spatialReference=s
break
case"LineString":h.paths=[r.coordinates.slice(0)],h.spatialReference=s
break
case"MultiLineString":h.paths=r.coordinates.slice(0),h.spatialReference=s
break
case"Polygon":h.rings=i(r.coordinates.slice(0)),h.spatialReference=s
break
case"MultiPolygon":h.rings=o(r.coordinates.slice(0)),h.spatialReference=s
break
case"Feature":h.geometry=l(r.geometry),h.attributes=t(r.properties)
break
case"FeatureCollection":for(h=[],a=0;a<r.features.length;a++)h.push(l(r.features[a]))
break
case"GeometryCollection":for(h=[],a=0;a<r.geometries.length;a++)h.push(l(r.geometries[a]))}return h}var h={}
return h.parse=a,h.convert=l,h.toGeoJSON=a,h.fromGeoJSON=l,h}),function(e,t){if("object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=t(require("terraformer"))),"object"==typeof e.navigator){if(!e.Terraformer)throw new Error("Terraformer.RTree requires the core Terraformer library. https://github.com/esri/Terraformer")
e.Terraformer.RTree=t(e.Terraformer).RTree}}(this,function(e){function t(e){return"[object Array]"===Object.prototype.toString.call(e)}var r={},i=function(r){var o=3,n=6
isNaN(r)||(o=Math.floor(r/2),n=r),this.min_width=o,this.max_width=n
var s={x:0,y:0,w:0,h:0,id:"root",nodes:[]}
!function(){var e={}
return function(t){var r=0
return t in e?r=e[t]++:e[t]=0,t+"_"+r}}(),i.Rectangle.squarified_ratio=function(e,t,r){var i=(e+t)/2,o=e*t,n=o/(i*i)
return o*r/n}
var a=function(e,t,r){var n=[],s=[],a=[],l=1
if(!e||!i.Rectangle.overlap_rectangle(e,r))return a
var h={x:e.x,y:e.y,w:e.w,h:e.h,target:t}
s.push(r.nodes.length),n.push(r)
do{var c=n.pop(),u=s.pop()-1
if("target"in h)for(;u>=0;){var p=c.nodes[u]
if(i.Rectangle.overlap_rectangle(h,p)){if(h.target&&"leaf"in p&&p.leaf===h.target||!h.target&&("leaf"in p||i.Rectangle.contains_rectangle(p,h))){"nodes"in p?(a=f(p,!0,[],p),c.nodes.splice(u,1)):a=c.nodes.splice(u,1),i.Rectangle.make_MBR(c.nodes,c),delete h.target,c.nodes.length<o&&(h.nodes=f(c,!0,[],c))
break}"nodes"in p&&(l+=1,s.push(u),n.push(c),c=p,u=p.nodes.length)}u-=1}else if("nodes"in h){c.nodes.splice(u+1,1),c.nodes.length>0&&i.Rectangle.make_MBR(c.nodes,c)
for(var d=0;d<h.nodes.length;d++)y(h.nodes[d],c)
h.nodes.length=0,0===n.length&&c.nodes.length<=1?(h.nodes=f(c,!0,h.nodes,c),c.nodes.length=0,n.push(c),s.push(1)):n.length>0&&c.nodes.length<o?(h.nodes=f(c,!0,h.nodes,c),c.nodes.length=0):delete h.nodes}else i.Rectangle.make_MBR(c.nodes,c)
l-=1}while(n.length>0)
return a},l=function(e,t){var r,o=-1,n=[]
n.push(t)
var s=t.nodes
do{-1!==o&&(n.push(s[o]),s=s[o].nodes,o=-1)
for(var a=s.length-1;a>=0;a--){var l=s[a]
if("leaf"in l){o=-1
break}var h=i.Rectangle.squarified_ratio(l.w,l.h,l.nodes.length+1),c=Math.max(l.x+l.w,e.x+e.w)-Math.min(l.x,e.x),u=Math.max(l.y+l.h,e.y+e.h)-Math.min(l.y,e.y),p=i.Rectangle.squarified_ratio(c,u,l.nodes.length+2);(0>o||Math.abs(p-h)<r)&&(r=Math.abs(p-h),o=a)}}while(-1!==o)
return n},h=function(e){for(var t=u(e);e.length>0;)c(e,t[0],t[1])
return t},c=function(e,t,r){for(var n,s,a,l=i.Rectangle.squarified_ratio(t.w,t.h,t.nodes.length+1),h=i.Rectangle.squarified_ratio(r.w,r.h,r.nodes.length+1),c=e.length-1;c>=0;c--){var u=e[c],p={}
p.x=Math.min(t.x,u.x),p.y=Math.min(t.y,u.y),p.w=Math.max(t.x+t.w,u.x+u.w)-p.x,p.h=Math.max(t.y+t.h,u.y+u.h)-p.y
var f=Math.abs(i.Rectangle.squarified_ratio(p.w,p.h,t.nodes.length+2)-l),d={}
d.x=Math.min(r.x,u.x),d.y=Math.min(r.y,u.y),d.w=Math.max(r.x+r.w,u.x+u.w)-d.x,d.h=Math.max(r.y+r.h,u.y+u.h)-d.y
var y=Math.abs(i.Rectangle.squarified_ratio(d.w,d.h,r.nodes.length+2)-h);(!s||!n||Math.abs(y-f)<n)&&(s=c,n=Math.abs(y-f),a=f>y?r:t)}var g=e.splice(s,1)[0]
t.nodes.length+e.length+1<=o?(t.nodes.push(g),i.Rectangle.expand_rectangle(t,g)):r.nodes.length+e.length+1<=o?(r.nodes.push(g),i.Rectangle.expand_rectangle(r,g)):(a.nodes.push(g),i.Rectangle.expand_rectangle(a,g))},u=function(e){for(var t,r,i=e.length-1,o=0,n=e.length-1,s=0,a=e.length-2;a>=0;a--){var l=e[a]
l.x>e[o].x?o=a:l.x+l.w<e[i].x+e[i].w&&(i=a),l.y>e[s].y?s=a:l.y+l.h<e[n].y+e[n].h&&(n=a)}var h=Math.abs(e[i].x+e[i].w-e[o].x),c=Math.abs(e[n].y+e[n].h-e[s].y)
return h>c?i>o?(t=e.splice(i,1)[0],r=e.splice(o,1)[0]):(r=e.splice(o,1)[0],t=e.splice(i,1)[0]):n>s?(t=e.splice(n,1)[0],r=e.splice(s,1)[0]):(r=e.splice(s,1)[0],t=e.splice(n,1)[0]),[{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]},{x:r.x,y:r.y,w:r.w,h:r.h,nodes:[r]}]},p=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},f=function(e,t,r,o){var n=[]
if(!i.Rectangle.overlap_rectangle(e,o))return r
n.push(o.nodes)
do for(var s=n.pop(),a=s.length-1;a>=0;a--){var l=s[a]
i.Rectangle.overlap_rectangle(e,l)&&("nodes"in l?n.push(l.nodes):"leaf"in l&&(t?r.push(l):r.push(l.leaf)))}while(n.length>0)
return r},d=function(e,t,r,o){var n=[]
if(!i.Rectangle.overlap_rectangle(o,e))return r
n.push(o.nodes)
do for(var s=n.pop(),a=s.length-1;a>=0;a--){var l=s[a]
i.Rectangle.overlap_rectangle(l,e)&&("nodes"in l?n.push(l.nodes):"leaf"in l&&(t?r.push(l):r.push(l.leaf)))}while(n.length>0)
return r},y=function(e,r){var o
if(0===r.nodes.length)return r.x=e.x,r.y=e.y,r.w=e.w,r.h=e.h,void r.nodes.push(e)
var s=l(e,r),a=e
do{if(o&&"nodes"in o&&0===o.nodes.length){var c=o
o=s.pop()
for(var u=0;u<o.nodes.length;u++)if(o.nodes[u]===c||0===o.nodes[u].nodes.length){o.nodes.splice(u,1)
break}}else o=s.pop()
if("leaf"in a||"nodes"in a||t(a)){if(t(a)){for(var p=0;p<a.length;p++)i.Rectangle.expand_rectangle(o,a[p])
o.nodes=o.nodes.concat(a)}else i.Rectangle.expand_rectangle(o,a),o.nodes.push(a)
if(o.nodes.length<=n)a={x:o.x,y:o.y,w:o.w,h:o.h}
else{var f=h(o.nodes)
a=f,s.length<1&&(o.nodes.push(f[0]),s.push(o),a=f[1])}}else i.Rectangle.expand_rectangle(o,a),a={x:o.x,y:o.y,w:o.w,h:o.h}}while(s.length>0)}
this.serialize=function(e){e(null,s)},this.deserialize=function(e,t,r){var i=Array.prototype.slice.call(arguments)
switch(i.length){case 1:t=s
break
case 2:"function"==typeof i[1]&&(t=s,r=i[1])}var o=p(t,e)
r&&r(null,o)},this.search=function(t,r){var i
if(t.type){var o=e.Tools.calculateBounds(t)
i={x:o[0],y:o[1],w:Math.abs(o[0]-o[2]),h:Math.abs(o[1]-o[3])}}else i=t
var n=[i,!1,[],s]
if(void 0===i)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle."
var a=f.apply(this,n)
r&&r(null,a)},this.within=function(t,r){var i
if(t.type){var o=e.Tools.calculateBounds(t)
i={x:o[0],y:o[1],w:Math.abs(o[0]-o[2]),h:Math.abs(o[1]-o[3])}}else i=t
var n=[i,!1,[],s]
if(void 0===i)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle."
var a=d.apply(this,n)
r&&r(null,a)},this.remove=function(t,r,i){var o=Array.prototype.slice.call(arguments)
if(1===o.length&&o.push(!1),3===o.length&&(i=o.pop()),o&&o[0]&&o[0].type){var n=e.Tools.calculateBounds(o[0])
o[0]={x:n[0],y:n[1],w:Math.abs(n[0]-n[2]),h:Math.abs(n[1]-n[3])}}if(o.push(s),r===!1){var l=0,h=[]
do l=h.length,h=h.concat(a.apply(this,o))
while(l!==h.length)
i&&i(null,h)}else{var c=a.apply(this,o)
i&&i(null,c)}},this.insert=function(t,r,i){var o
if(t.type){var n=e.Tools.calculateBounds(t)
o={x:n[0],y:n[1],w:Math.abs(n[0]-n[2]),h:Math.abs(n[1]-n[3])}}else o=t
if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle or GeoJSON and an object."
var a=y({x:o.x,y:o.y,w:o.w,h:o.h,leaf:r},s)
i&&i(null,a)}}
return i.Rectangle=function(e,t,r,i){var o,n,s,a,l,h
e.x?(o=e.x,s=e.y,0!==e.w&&!e.w&&e.x2?(l=e.x2-e.x,h=e.y2-e.y):(l=e.w,h=e.h),n=o+l,a=s+h):(o=e,s=t,l=r,h=i,n=o+l,a=s+h),this.x1=this.x=function(){return o},this.y1=this.y=function(){return s},this.x2=function(){return n},this.y2=function(){return a},this.w=function(){return l},this.h=function(){return h},this.toJSON=function(){return'{"x":'+o.toString()+', "y":'+s.toString()+', "w":'+l.toString()+', "h":'+h.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),r=Math.min(this.y(),e.y())
return l=Math.max(this.x2(),e.x2())-t,h=Math.max(this.y2(),e.y2())-r,o=t,s=r,this},this.setRect=function(e,t,r,i){var o,n,s,a,l,h
e.x?(o=e.x,s=e.y,0!==e.w&&!e.w&&e.x2?(l=e.x2-e.x,h=e.y2-e.y):(l=e.w,h=e.h),n=o+l,a=s+h):(o=e,s=t,l=r,h=i,n=o+l,a=s+h)}},i.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},i.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},i.Rectangle.expand_rectangle=function(e,t){var r,i
return r=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y,e.w=e.x+e.w>t.x+t.w?e.x+e.w-r:t.x+t.w-r,e.h=e.y+e.h>t.y+t.h?e.y+e.h-i:t.y+t.h-i,e.x=r,e.y=i,e},i.Rectangle.make_MBR=function(e,t){if(e.length<1)return{x:0,y:0,w:0,h:0}
t?(t.x=e[0].x,t.y=e[0].y,t.w=e[0].w,t.h=e[0].h):t={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h}
for(var r=e.length-1;r>0;r--)i.Rectangle.expand_rectangle(t,e[r])
return t},r.RTree=i,r}),L.esri={_callback:{}},L.esri.Support={CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest)},L.esri.RequestHandlers={CORS:function(e,t,r,i){var o=new XMLHttpRequest
t.f="json",o.onreadystatechange=function(){var e
if(4===o.readyState){try{e=JSON.parse(o.responseText)}catch(t){e={error:"Could not parse response as JSON."}}i?r.call(i,e):r(e)}},o.open("GET",e+L.esri.Util.serialize(t),!0),o.send(null)},JSONP:function(e,t,r,i){var o="c"+(1e9*Math.random()).toString(36).replace(".","_")
t.f="json",t.callback="L.esri._callback."+o
var n=document.createElement("script")
n.type="text/javascript",n.src=e+L.esri.Util.serialize(t),n.id=o,L.esri._callback[o]=function(e){i?r.call(i,e):r(e),document.body.removeChild(n),delete L.esri._callback[o]},document.body.appendChild(n)}},L.esri.get=L.esri.Support.CORS?L.esri.RequestHandlers.CORS:L.esri.RequestHandlers.JSONP,L.esri.Util={debounce:function(e,t){var r=null
return function(){var i=this||i,o=arguments
clearTimeout(r),r=setTimeout(function(){e.apply(i,o)},t)}},roundAwayFromZero:function(e){return e>0?Math.ceil(e):Math.floor(e)},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},cleanUrl:function(e){return e=L.esri.Util.trim(e),"/"!==e[e.length-1]&&(e+="/"),e},serialize:function(e){var t="?"
for(var r in e)if(e.hasOwnProperty(r)){var i=r,o=e[r]
t+=encodeURIComponent(i),t+="=",t+=encodeURIComponent(o),t+="&"}return t.substring(0,t.length-1)},indexOf:function(e,t,r){if(r=r||0,e.indexOf)return e.indexOf(t,r)
for(var i=r,o=e.length;o>i;i++)if(e[i]===t)return i
return-1},extentToBounds:function(e){var t=new L.LatLng(e.ymin,e.xmin),r=new L.LatLng(e.ymax,e.xmax)
return new L.LatLngBounds(t,r)},boundsToExtent:function(e){return{xmin:e.getSouthWest().lng,ymin:e.getSouthWest().lat,xmax:e.getNorthEast().lng,ymax:e.getNorthEast().lat,spatialReference:{wkid:4326}}},boundsToEnvelope:function(e){var t=L.esri.Util.boundsToExtent(e)
return{x:t.xmin,y:t.ymin,w:Math.abs(t.xmin-t.xmax),h:Math.abs(t.ymin-t.ymax)}}},L.esri.Mixins={},L.esri.Mixins.featureGrid={_activeRequests:0,_initializeFeatureGrid:function(e){this._map=e,this._previousCells=[],this.center=this._map.getCenter(),this.origin=this._map.project(this.center),this._moveHandler=L.esri.Util.debounce(function(e){"zoomend"===e.type&&(this.origin=this._map.project(this.center),this._previousCells=[]),this._requestFeatures(e.target.getBounds())},this.options.debounce,this),e.on("zoomend resize move",this._moveHandler,this),this._requestFeatures(e.getBounds())},_destroyFeatureGrid:function(e){e.off("zoomend resize move",this._moveHandler,this)},_requestFeatures:function(e){var t=this._cellsWithin(e)
t&&this.fire("loading",{bounds:e})
for(var r=0;r<t.length;r++)this._makeRequest(t[r],t,e)},_makeRequest:function(e,t,r){this._activeRequests++,L.esri.get(this.url+"query",{geometryType:"esriGeometryEnvelope",geometry:JSON.stringify(L.esri.Util.boundsToExtent(e.bounds)),outFields:"*",outSr:4326},function(e){this._activeRequests--,this._activeRequests<=0&&this.fire("load",{bounds:r,cells:t}),this._render(e)},this)},_cellsWithin:function(e){var t=this._map.getSize(),r=this._map.project(this._map.getCenter())
Math.min(this.options.cellSize/t.x,this.options.cellSize/t.y)
for(var i=e.pad(.1),o=[],n=this._map.project(i.getNorthWest()),s=this._map.project(i.getSouthEast()),a=n.subtract(r).divideBy(this.options.cellSize),l=s.subtract(r).divideBy(this.options.cellSize),h=Math.round((this.origin.x-r.x)/this.options.cellSize),c=Math.round((this.origin.y-r.y)/this.options.cellSize),u=L.esri.Util.roundAwayFromZero(a.x)-h,p=L.esri.Util.roundAwayFromZero(l.x)-h,f=L.esri.Util.roundAwayFromZero(a.y)-c,d=L.esri.Util.roundAwayFromZero(l.y)-c,y=u;p>y;y++)for(var g=f;d>g;g++){var m="cell:"+y+":"+g,v=L.esri.Util.indexOf(this._previousCells,m)>=0
if(!v||!this.options.deduplicate){var _=this._cellExtent(y,g),x=_.getCenter(),w=x.distanceTo(_.getNorthWest()),b=x.distanceTo(this.center),M={row:y,col:g,id:m,center:x,bounds:_,distance:b,radius:w}
o.push(M),this._previousCells.push(m)}}return o.sort(function(e,t){return e.distance-t.distance}),o},_cellExtent:function(e,t){var r=this._cellPoint(e,t),i=this._cellPoint(e+1,t+1),o=this._map.unproject(r),n=this._map.unproject(i)
return L.latLngBounds(o,n)},_cellPoint:function(e,t){var r=this.origin.x+e*this.options.cellSize,i=this.origin.y+t*this.options.cellSize
return[r,i]}},L.esri.Mixins.identifiableLayer={identify:function(e,t,r){var i,o={sr:"4265",mapExtent:JSON.stringify(L.esri.Util.boundsToExtent(this._map.getBounds())),tolerance:3,geometryType:"esriGeometryPoint",imageDisplay:"800,600,96",geometry:JSON.stringify({x:e.lng,y:e.lat,spatialReference:{wkid:4265}})}
"function"==typeof t&&"undefined"==typeof r?(r=t,i=o):"object"==typeof t&&(t.layerDefs&&(t.layerDefs=this.parseLayerDefs(t.layerDefs)),i=L.Util.extend(o,t)),L.esri.get(this._url+"/identify",i,r)},parseLayerDefs:function(e){return e instanceof Array?"":"object"==typeof e?JSON.stringify(e):e}},function(e){var t="https:"!==window.location.protocol?"http:":"https:",r="line-height:9px; text-overflow:ellipsis; white-space:nowrap;overflow:hidden; display:inline-block;",i="position:absolute; top:-38px; right:2px;",o="<img src='https://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo' style='"+i+"'>",n=function(e){return"<span class='esri-attributions' style='"+r+"'>"+e+"</span>"}
e.esri.BasemapLayer=e.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}/",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:n("Esri")+o}},Topographic:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}/",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:n("Esri")+o}},Oceans:{urlTemplate:"https://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}/",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:n("Esri")+o}},NationalGeographic:{urlTemplate:"https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:n("Esri")+o}},Gray:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:n("Esri, NAVTEQ, DeLorme")+o}},GrayLabels:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:16,subdomains:["server","services"]}},Imagery:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:n("Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community")+o}},ImageryLabels:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:19,subdomains:["server","services"]}},ImageryTransportation:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:19,subdomains:["server","services"]}},ImageryAlternateLabels:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:12,subdomains:["server","services"]}},ShadedRelief:{urlTemplate:t+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}/",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:n("ESRI, NAVTEQ, DeLorme")+o}}}},initialize:function(t,r){var i
if("object"==typeof t&&t.urlTemplate&&t.options)i=t
else{if("string"!=typeof t||!e.esri.BasemapLayer.TILES[t])throw new Error("L.esri.BasemapLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery', 'ImageryLabels', 'ImageryTransportation', 'ImageryAlternateLabels' or 'ShadedRelief'")
i=e.esri.BasemapLayer.TILES[t]}var o=e.Util.extend(i.options,r),n=e.esri.Util.cleanUrl(i.urlTemplate)
if(e.TileLayer.prototype.initialize.call(this,n,e.Util.setOptions(this,o)),i.attributionUrl){var s=e.esri.Util.cleanUrl(i.attributionUrl)
this._dynamicAttribution=!0,this._getAttributionData(s)}},_dynamicAttribution:!1,bounds:null,zoom:null,onAdd:function(t){e.TileLayer.prototype.onAdd.call(this,t),this._dynamicAttribution&&(this.on("load",this._handleTileUpdates,this),this._map.on("viewreset zoomend dragend",this._handleTileUpdates,this)),this._map.on("resize",this._resizeAttribution,this)},onRemove:function(t){this._dynamicAttribution&&(this.off("load",this._handleTileUpdates,this),this._map.off("viewreset zoomend dragend",this._handleTileUpdates,this)),this._map.off("resize",this._resizeAttribution,this),e.TileLayer.prototype.onRemove.call(this,t)},_handleTileUpdates:function(e){var t,r
"load"===e.type&&(t=this._map.getBounds(),r=this._map.getZoom()),("viewreset"===e.type||"dragend"===e.type||"zoomend"===e.type)&&(t=e.target.getBounds(),r=e.target.getZoom()),this.attributionBoundingBoxes&&t&&r&&(t.equals(this.bounds)&&r===this.zoom||(this.bounds=t,this.zoom=r,this._updateMapAttribution()))},_resizeAttribution:function(){var e=this._map.getSize().x
this._getAttributionLogo().style.display=600>e?"none":"block",this._getAttributionSpan().style.maxWidth=.75*e+"px"},_getAttributionData:function(t){this.attributionBoundingBoxes=[],e.esri.get(t,{},this._processAttributionData,this)},_processAttributionData:function(t){for(var r=0;r<t.contributors.length;r++)for(var i=t.contributors[r],o=0;o<i.coverageAreas.length;o++){var n=i.coverageAreas[o],s=new e.LatLng(n.bbox[0],n.bbox[1]),a=new e.LatLng(n.bbox[2],n.bbox[3])
this.attributionBoundingBoxes.push({attribution:i.attribution,score:n.score,bounds:new e.LatLngBounds(s,a),minZoom:n.zoomMin,maxZoom:n.zoomMax})}this.attributionBoundingBoxes.sort(function(e,t){return e.score<t.score?-1:e.score>t.score?1:0}),this.bounds&&this._updateMapAttribution()},_getAttributionSpan:function(){return this._map._container.querySelectorAll(".esri-attributions")[0]},_getAttributionLogo:function(){return this._map._container.querySelectorAll(".esri-attribution-logo")[0]},_updateMapAttribution:function(){for(var e="",t=0;t<this.attributionBoundingBoxes.length;t++){var r=this.attributionBoundingBoxes[t]
if(this.bounds.intersects(r.bounds)&&this.zoom>=r.minZoom&&this.zoom<=r.maxZoom){var i=this.attributionBoundingBoxes[t].attribution;-1===e.indexOf(i)&&(e.length>0&&(e+=", "),e+=i)}}this._getAttributionSpan().innerHTML=e,this._resizeAttribution()}}),e.esri.basemapLayer=function(t,r){return new e.esri.BasemapLayer(t,r)}}(L),function(e){function t(e,t){var r=t?"block":"none"
if(e._icon&&(e._icon.style.display=r),e._shadow&&(e._shadow.style.display=r),e._layers)for(var i in e._layers)e._layers.hasOwnProperty(i)&&(e._layers[i]._container.style.display=r)}e.esri.FeatureLayer=e.GeoJSON.extend({includes:e.esri.Mixins.featureGrid,options:{cellSize:512,debounce:100,deduplicate:!0},initialize:function(t,r){this.index=new Terraformer.RTree,this.url=e.esri.Util.cleanUrl(t),e.Util.setOptions(this,r),e.esri.get(this.url,{},function(e){this.fire("metadata",{metadata:e})},this),e.GeoJSON.prototype.initialize.call(this,[],r)},onAdd:function(t){e.LayerGroup.prototype.onAdd.call(this,t),t.on("zoomend resize move",this._update,this),this._initializeFeatureGrid(t)},onRemove:function(t){t.off("zoomend resize move",this._update,this),e.LayerGroup.prototype.onRemove.call(this,t),this._destroyFeatureGrid(t)},getLayerId:function(e){return e.feature.id},_update:function(r){var i=e.esri.Util.boundsToEnvelope(r.target.getBounds())
this.index.search(i,e.Util.bind(function(r,i){this.eachLayer(e.Util.bind(function(r){var o=r.feature.id
t(r,e.esri.Util.indexOf(i,o)>=0)},this))},this))},_render:function(e){if(e.objectIdFieldName&&e.features.length&&!e.error)for(var t=e.objectIdFieldName,r=e.features.length-1;r>=0;r--){var i=e.features[r],o=i.attributes[t]
if(!this._layers[o]){var n=Terraformer.ArcGIS.parse(i)
n.id=o,this.index.insert(n,o),this.addData(n)
var s=this._layers[o]
this.fire("render",{feature:s,geojson:n})}}}}),e.esri.featureLayer=function(t,r){return new e.esri.FeatureLayer(t,r)}}(L),L.esri.TiledMapLayer=L.TileLayer.extend({includes:L.esri.Mixins.identifiableLayer,initialize:function(e,t){t=t||{},this.serviceUrl=L.esri.Util.cleanUrl(e),this.tileUrl=this.serviceUrl+"tile/{z}/{y}/{x}",this.tileUrl.match("://tiles.arcgis.com")&&(this.tileUrl=this.tileUrl.replace("://tiles.arcgis.com","://tiles{s}.arcgis.com"),t.subdomains=["1","2","3","4"]),L.esri.get(this.serviceUrl,{},function(e){this.fire("metadata",{metadata:e})},this),L.TileLayer.prototype.initialize.call(this,this.tileUrl,t)}}),L.esri.tiledMapLayer=function(e,t){return new L.esri.TiledMapLayer(e,t)},L.esri.DynamicMapLayer=L.ImageOverlay.extend({includes:L.esri.Mixins.identifiableLayer,defaultParams:{format:"png8",transparent:!0,f:"image",bboxSR:102100,imageSR:102100,layers:"",opacity:1},initialize:function(e,t){this._url=L.esri.Util.cleanUrl(e),this._layerParams=L.Util.extend({},this.defaultParams)
for(var r in t)this.options.hasOwnProperty(r)||(this._layerParams[r]=t[r])
delete this._layerParams.token,this._parseLayers(),this._parseLayerDefs(),L.esri.get(this._url,{},function(e){this.fire("metadata",{metadata:e})},this),L.Util.setOptions(this,t)},onAdd:function(e){if(this._map=e,this._image||this._initImage(),e._panes.overlayPane.appendChild(this._image),e.on({viewreset:this._reset,moveend:this._update,zoomend:this._zoomUpdate},this),e.options.zoomAnimation&&L.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),e.options.crs&&e.options.crs.code){var t=e.options.crs.code.split(":")[1]
this._layerParams.bboxSR=t,this._layerParams.imageSR=t}this._reset()},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._image),e.off({viewreset:this._reset,moveend:this._update},this),e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this)},_animateZoom:function(e){var t=this._map,r=this._image,i=t.getZoomScale(e.zoom),o=this._map.getBounds().getNorthWest(),n=this._map.getBounds().getSouthEast(),s=t._latLngToNewLayerPoint(o,e.zoom,e.center),a=t._latLngToNewLayerPoint(n,e.zoom,e.center)._subtract(s),l=s._add(a._multiplyBy(.5*(1-1/i)))
r.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(l)+" scale("+i+") "},_parseLayers:function(){if("undefined"==typeof this._layerParams.layers)return void delete this._layerParams.layerOption
var e=this._layerParams.layerOption||null,t=this._layerParams.layers||null,r="show",i=["show","hide","include","exclude"]
if(delete this._layerParams.layerOption,e)-1!==i.indexOf(e)&&(r=e),this._layerParams.layers=r+":"+t
else if(t instanceof Array)this._layerParams.layers=r+":"+t.join(",")
else if("string"==typeof t){var o=t.match(":")
o&&(t=t.split(o[0]),Number(t[1].split(",")[0])&&(-1!==i.indexOf(t[0])&&(r=t[0]),t=t[1])),this._layerParams.layers=r+":"+t}},_parseLayerDefs:function(){if("undefined"!=typeof this._layerParams.layerDefs){var e=this._layerParams.layerDefs,t=[]
if(e instanceof Array)for(var r=e.length,i=0;r>i;i++)e[i]&&t.push(i+":"+e[i])
else{if("object"!=typeof e)return void delete this._layerParams.layerDefs
for(var o in e)e.hasOwnProperty(o)&&t.push(o+":"+e[o])}this._layerParams.layerDefs=t.join(";")}},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this),src:this._getImageUrl()})},_getImageUrl:function(){var e=this._map.getBounds(),t=this._map.getSize(),r=this._map.options.crs.project(e._northEast),i=this._map.options.crs.project(e._southWest)
this._layerParams.bbox=[i.x,i.y,r.x,r.y].join(","),this._layerParams.size=t.x+","+t.y
var o=this._url+"export"+L.Util.getParamString(this._layerParams)
return"undefined"!=typeof this.options.token&&(o=o+"&token="+this.options.token),o},_update:function(){if(!this._map._panTransition||!this._map._panTransition._inProgress){var e=this._map.getZoom()
e>this.options.maxZoom||e<this.options.minZoom||(this._newImage=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._newImage,"leaflet-zoom-animated"):L.DomUtil.addClass(this._newImage,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._newImage,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onNewImageLoad,this),src:this._getImageUrl()}))}},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity),this._newImage&&L.DomUtil.setOpacity(this._newImage,this.options.opacity)},_zoomUpdate:function(){},_onNewImageLoad:function(){var e=this._map.getBounds(),t=L.latLng(e._northEast.lat,e._southWest.lng),r=L.latLng(e._southWest.lat,e._northEast.lng),i=this._map.latLngToLayerPoint(t),o=this._map.latLngToLayerPoint(r)._subtract(i)
L.DomUtil.setPosition(this._newImage,i),this._newImage.style.width=o.x+"px",this._newImage.style.height=o.y+"px",null==this._image?this._map._panes.overlayPane.appendChild(this._newImage):this._map._panes.overlayPane.insertBefore(this._newImage,this._image),this._map._panes.overlayPane.removeChild(this._image),this._image=this._newImage,this._newImage=null},_onImageLoad:function(){this.fire("load")},_reset:function(){}}),L.esri.dynamicMapLayer=function(e,t){return new L.esri.DynamicMapLayer(e,t)}
